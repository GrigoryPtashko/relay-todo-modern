{"version":3,"sources":["../../server/subscriptionHandler.js"],"names":["subscribe","request","updateCallback","console","log","query","variables","schema","context","subscript2RabbitMQ","_subscript2RabbitMQ","result","on","msg","localTodoId","id","updatedPayload"],"mappings":";;;;;;;;;;AAAA;;AACA;;AAGA;;AAEA;;;;;;AAEA;AACA,IAAMA;AAAA,qEAAY,iBAAOC,OAAP,EAAgBC,cAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAChBC,oBAAQC,GAAR,CAAY,oBAAZ;AACOC,iBAFS,GAEWJ,OAFX,CAETI,KAFS,EAEFC,SAFE,GAEWL,OAFX,CAEFK,SAFE;AAAA;AAAA,mBAGK,gDAAiB;AACpCC,oCADoC;AAEpCF,0BAFoC;AAGpCG,uBAAS;AACPC,oCAAoB,8BAAM;AACxBN,0BAAQC,GAAR;AACAM,sCAAoBL,KAApB,EAA2BC,SAA3B,EAAsCJ,cAAtC;AACD;AAJM,eAH2B;AASpCI;AAToC,aAAjB,CAHL;;AAAA;AAGVK,kBAHU;AAAA,6CAcTA,MAdS;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAZ;;AAAA;AAAA;AAAA;AAAA,GAAN;;AAmBA,IAAMD,sBAAsB,SAAtBA,mBAAsB,CAACL,KAAD,EAAQC,SAAR,EAAmBJ,cAAnB,EAAsC;AAChE,mBAAOU,EAAP,CAAU,cAAV;AAAA,wEAA0B,kBAAMC,GAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AACbC,yBADa,GACED,GADF,CACjBE,EADiB;AAAA;AAAA,qBAEK,sCAAgBV,KAAhB,EAAuB,EAACS,wBAAD,EAAvB,EAAsC,IAAtC,EAA4CR,SAA5C,CAFL;;AAAA;AAElBU,4BAFkB;;AAGxBd,6BAAec,cAAf;;AAHwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAA1B;;AAAA;AAAA;AAAA;AAAA;AAKD,CAND;;kBAQe,EAAChB,oBAAD,E","file":"subscriptionHandler.js","sourcesContent":["import {graphql} from 'graphql';\r\nimport {\r\n  graphqlSubscribe,\r\n} from 'graphql-relay-subscription';\r\nimport {schema} from '../data/schema';\r\n\r\nimport events from './events';\r\n\r\n//https://github.com/bochen2014/graphql-relay-subscription\r\nconst subscribe = async (request, updateCallback) => {\r\n  console.log('subscribe begin...');\r\n  const {query, variables} = request;\r\n  const result = await graphqlSubscribe({\r\n    schema,\r\n    query,\r\n    context: {\r\n      subscript2RabbitMQ: () => {\r\n        console.log(`pubSub.sub('amqp.changes', msg=>{ .....  })`);\r\n        _subscript2RabbitMQ(query, variables, updateCallback);\r\n      },\r\n    },\r\n    variables,\r\n  });\r\n  return result;\r\n};\r\n\r\n\r\n\r\nconst _subscript2RabbitMQ = (query, variables, updateCallback) => {\r\n  events.on('amqp.changes', async msg => {\r\n    const {id: localTodoId} = msg;\r\n    const updatedPayload = await graphql(schema, query, {localTodoId}, null, variables);\r\n    updateCallback(updatedPayload);\r\n  });\r\n}\r\n\r\nexport default {subscribe};"]}